"""
ä» STIX æ ¼å¼å¯¼å…¥ ATT&CK æ•°æ®

ä½¿ç”¨æ–¹æ³•:
    cd backend
    conda activate malapi-backend
    python scripts/maintenance/import_attack_from_stix.py [--clear]

å‚æ•°:
    --clear: æ¸…ç©ºç°æœ‰æ•°æ®åé‡æ–°å¯¼å…¥

æ•°æ®æº:
    attack-stix-data/enterprise-attack/enterprise-attack.json

å‚è€ƒæ–‡æ¡£: attack-stix-data/USAGE.md
"""
import sys
import argparse
from pathlib import Path
from datetime import datetime
import sqlite3

# æ·»åŠ é¡¹ç›®è·¯å¾„
SCRIPT_DIR = Path(__file__).parent.absolute()  # backend/scripts/maintenance
BACKEND_DIR = SCRIPT_DIR.parent.parent  # backend
PROJECT_ROOT = BACKEND_DIR.parent  # é¡¹ç›®æ ¹ç›®å½•
sys.path.insert(0, str(BACKEND_DIR))

from src.services.stix_data_service import STIXDataService
from src.utils.logger import setup_logger

logger = setup_logger(__name__)

# æ•°æ®åº“è·¯å¾„
DB_PATH = BACKEND_DIR / "malapi.db"


def clear_existing_data(conn, cursor):
    """æ¸…ç©ºç°æœ‰ ATT&CK æ•°æ®"""
    logger.warning("=" * 50)
    logger.warning("âš ï¸  æ¸…ç©ºç°æœ‰ ATT&CK æ•°æ®")
    logger.warning("=" * 50)

    # å…ˆåˆ é™¤æ˜ å°„å…³ç³»
    cursor.execute("DELETE FROM attck_mappings")
    mappings_count = cursor.rowcount
    logger.info(f"  â†’ åˆ é™¤æ˜ å°„å…³ç³»: {mappings_count} æ¡")

    # åˆ é™¤æŠ€æœ¯-æˆ˜æœ¯å…³è”è¡¨
    cursor.execute("DELETE FROM attack_technique_tactics")
    assoc_count = cursor.rowcount
    logger.info(f"  â†’ åˆ é™¤æŠ€æœ¯-æˆ˜æœ¯å…³è”: {assoc_count} æ¡")

    # åˆ é™¤æŠ€æœ¯
    cursor.execute("DELETE FROM attack_techniques")
    techniques_count = cursor.rowcount
    logger.info(f"  â†’ åˆ é™¤æŠ€æœ¯: {techniques_count} æ¡")

    # åˆ é™¤æˆ˜æœ¯
    cursor.execute("DELETE FROM attack_tactics")
    tactics_count = cursor.rowcount
    logger.info(f"  â†’ åˆ é™¤æˆ˜æœ¯: {tactics_count} æ¡")

    conn.commit()
    logger.info("âœ“ æ¸…ç©ºå®Œæˆ")


def import_tactics(stix_service, conn, cursor):
    """å¯¼å…¥æˆ˜æœ¯æ•°æ®"""
    logger.info("\n" + "=" * 50)
    logger.info("ğŸ”¹ æ­¥éª¤ 1: å¯¼å…¥æˆ˜æœ¯")
    logger.info("=" * 50)

    tactics = stix_service.get_all_tactics()
    imported_count = 0
    updated_count = 0

    for tactic in tactics:
        tactic_id = tactic['x_mitre_shortname']

        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        cursor.execute(
            "SELECT id FROM attack_tactics WHERE tactic_id = ?",
            (tactic_id,)
        )
        exists = cursor.fetchone()

        if exists:
            # æ›´æ–°
            cursor.execute("""
                UPDATE attack_tactics
                SET tactic_name_en = ?, description = ?, stix_id = ?, updated_at = CURRENT_TIMESTAMP
                WHERE tactic_id = ?
            """, (tactic['name'], tactic.get('description', ''), tactic.get('id', ''), tactic_id))
            updated_count += 1
        else:
            # æ’å…¥
            cursor.execute("""
                INSERT INTO attack_tactics (tactic_id, tactic_name_en, description, stix_id)
                VALUES (?, ?, ?, ?)
            """, (tactic_id, tactic['name'], tactic.get('description', ''), tactic.get('id', '')))
            imported_count += 1

    conn.commit()
    logger.info(f"âœ“ æ–°å¯¼å…¥æˆ˜æœ¯: {imported_count} æ¡")
    logger.info(f"âœ“ æ›´æ–°æˆ˜æœ¯: {updated_count} æ¡")

    return imported_count, updated_count


def import_techniques(stix_service, conn, cursor):
    """å¯¼å…¥æŠ€æœ¯å’Œå­æŠ€æœ¯æ•°æ®"""
    logger.info("\n" + "=" * 50)
    logger.info("ğŸ”¹ æ­¥éª¤ 2: å¯¼å…¥æŠ€æœ¯å’Œå­æŠ€æœ¯")
    logger.info("=" * 50)

    techniques = stix_service.get_all_techniques(include_subtechniques=True)
    technique_count = 0
    subtechnique_count = 0
    updated_count = 0
    skipped_count = 0

    for tech in techniques:
        # è·å– ATT&CK ID
        attack_id = None
        for ref in tech.get('external_references', []):
            if ref.get('source_name') == 'mitre-attack':
                attack_id = ref.get('external_id')
                break

        if not attack_id:
            continue

        # è·å–æˆ˜æœ¯ (kill_chain_phases)
        tactic_shortname = None
        for phase in tech.get('kill_chain_phases', []):
            if phase.get('kill_chain_name') == 'mitre-attack':
                tactic_shortname = phase.get('phase_name')
                break

        if not tactic_shortname:
            continue

        # å¤„ç†ä¿®æ”¹æ—¶é—´
        modified_str = tech.get('modified', '')
        if modified_str and hasattr(modified_str, '__class__') and 'STIX' in str(modified_str.__class__):
            # STIX datetime å¯¹è±¡ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²
            modified_str = str(modified_str)

        # å¤„ç†å¹³å°
        platforms = tech.get('x_mitre_platforms', [])
        platforms_str = ','.join(platforms) if platforms else None

        # ç¡®å®šæ˜¯å¦ä¸ºå­æŠ€æœ¯
        is_subtechnique = tech.get('x_mitre_is_subtechnique', False)

        # æå–çˆ¶æŠ€æœ¯ID
        parent_technique_id = None
        if is_subtechnique and '.' in attack_id:
            parent_technique_id = attack_id.rsplit('.', 1)[0]

        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        cursor.execute(
            "SELECT id FROM attack_techniques WHERE technique_id = ?",
            (attack_id,)
        )
        exists = cursor.fetchone()

        if exists:
            # æ›´æ–°
            cursor.execute("""
                UPDATE attack_techniques
                SET technique_name = ?, tactic_id = ?, is_sub_technique = ?,
                    parent_technique_id = ?, description = ?, stix_id = ?,
                    mitre_description = ?, mitre_url = ?, mitre_detection = ?,
                    platforms = ?, revoked = ?, deprecated = ?,
                    mitre_updated_at = ?, data_source = 'stix_enterprise',
                    updated_at = CURRENT_TIMESTAMP
                WHERE technique_id = ?
            """, (
                tech.get('name', ''),
                tactic_shortname,
                1 if is_subtechnique else 0,
                parent_technique_id,
                tech.get('description', ''),
                tech.get('id', ''),
                tech.get('description', ''),
                f"https://attack.mitre.org/techniques/{attack_id.replace('.', '/')}/",
                tech.get('x_mitre_detection', ''),
                platforms_str,
                1 if tech.get('revoked', False) else 0,
                1 if tech.get('x_mitre_deprecated', False) else 0,
                modified_str,
                attack_id
            ))
            updated_count += 1
        else:
            # æ’å…¥
            cursor.execute("""
                INSERT INTO attack_techniques (
                    technique_id, technique_name, tactic_id, is_sub_technique, parent_technique_id,
                    description, stix_id, mitre_description, mitre_url, mitre_detection,
                    platforms, revoked, deprecated, mitre_updated_at, data_source
                )
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'stix_enterprise')
            """, (
                attack_id,
                tech.get('name', ''),
                tactic_shortname,
                1 if is_subtechnique else 0,
                parent_technique_id,
                tech.get('description', ''),
                tech.get('id', ''),
                tech.get('description', ''),
                f"https://attack.mitre.org/techniques/{attack_id.replace('.', '/')}/",
                tech.get('x_mitre_detection', ''),
                platforms_str,
                1 if tech.get('revoked', False) else 0,
                1 if tech.get('x_mitre_deprecated', False) else 0,
                modified_str
            ))

            if is_subtechnique:
                subtechnique_count += 1
            else:
                technique_count += 1

    conn.commit()
    logger.info(f"âœ“ æ–°å¯¼å…¥çˆ¶æŠ€æœ¯: {technique_count} æ¡")
    logger.info(f"âœ“ æ–°å¯¼å…¥å­æŠ€æœ¯: {subtechnique_count} æ¡")
    logger.info(f"âœ“ æ›´æ–°æŠ€æœ¯: {updated_count} æ¡")

    return technique_count, subtechnique_count, updated_count


def verify_import(cursor):
    """éªŒè¯å¯¼å…¥ç»“æœ"""
    logger.info("\n" + "=" * 50)
    logger.info("ğŸ”¹ æ­¥éª¤ 3: éªŒè¯å¯¼å…¥ç»“æœ")
    logger.info("=" * 50)

    # ç»Ÿè®¡
    cursor.execute("SELECT COUNT(*) FROM attack_tactics")
    tactics_count = cursor.fetchone()[0]

    cursor.execute("SELECT COUNT(*) FROM attack_techniques")
    techniques_count = cursor.fetchone()[0]

    cursor.execute("SELECT COUNT(*) FROM attack_techniques WHERE is_sub_technique = 1")
    subtechniques_count = cursor.fetchone()[0]

    cursor.execute("SELECT COUNT(*) FROM attack_techniques WHERE is_sub_technique = 0")
    parent_techniques_count = cursor.fetchone()[0]

    logger.info(f"\nğŸ“Š æ•°æ®åº“ç»Ÿè®¡:")
    logger.info(f"  æˆ˜æœ¯ (Tactics): {tactics_count} æ¡")
    logger.info(f"  çˆ¶æŠ€æœ¯ (Techniques): {parent_techniques_count} æ¡")
    logger.info(f"  å­æŠ€æœ¯ (Sub-techniques): {subtechniques_count} æ¡")
    logger.info(f"  æ€»æŠ€æœ¯ (Total): {techniques_count} æ¡")

    # æ˜¾ç¤ºæ•°æ®ç¤ºä¾‹
    logger.info(f"\nğŸ“‹ æ•°æ®ç¤ºä¾‹:")

    # æˆ˜æœ¯ç¤ºä¾‹
    cursor.execute("SELECT tactic_id, tactic_name_en FROM attack_tactics ORDER BY tactic_id LIMIT 3")
    logger.info(f"\næˆ˜æœ¯ç¤ºä¾‹:")
    for row in cursor.fetchall():
        logger.info(f"  - {row[0]}: {row[1]}")

    # æŠ€æœ¯ç¤ºä¾‹
    cursor.execute("""
        SELECT technique_id, technique_name, is_sub_technique
        FROM attack_techniques
        ORDER BY is_sub_technique, technique_id
        LIMIT 5
    """)
    logger.info(f"\næŠ€æœ¯ç¤ºä¾‹:")
    for row in cursor.fetchall():
        sub_mark = "  â””â”€" if row[2] else "â—"
        logger.info(f"  {sub_mark} {row[0]}: {row[1]}")


def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(
        description="ä» STIX æ ¼å¼å¯¼å…¥ ATT&CK æ•°æ®",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  # å¯¼å…¥æ•°æ®ï¼ˆä¿ç•™ç°æœ‰æ•°æ®ï¼‰
  python scripts/maintenance/import_attack_from_stix.py

  # æ¸…ç©ºç°æœ‰æ•°æ®åé‡æ–°å¯¼å…¥
  python scripts/maintenance/import_attack_from_stix.py --clear
        """
    )
    parser.add_argument(
        '--clear',
        action='store_true',
        help='æ¸…ç©ºç°æœ‰æ•°æ®åé‡æ–°å¯¼å…¥'
    )
    args = parser.parse_args()

    print("=" * 60)
    print("  MalAPI - STIX ATT&CK æ•°æ®å¯¼å…¥å·¥å…·")
    print("=" * 60)

    # æ£€æŸ¥æ•°æ®åº“
    if not DB_PATH.exists():
        logger.error(f"âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨: {DB_PATH}")
        return False

    logger.info(f"ğŸ“„ æ•°æ®åº“: {DB_PATH}")

    # æ£€æŸ¥ STIX æ–‡ä»¶
    stix_path = PROJECT_ROOT / "attack-stix-data" / "enterprise-attack" / "enterprise-attack.json"
    if not stix_path.exists():
        logger.error(f"âŒ STIX æ–‡ä»¶ä¸å­˜åœ¨: {stix_path}")
        logger.error(f"   è¯·ç¡®ä¿ Git å­æ¨¡å—å·²åˆå§‹åŒ–:")
        logger.error(f"   git submodule update --init --recursive")
        return False

    logger.info(f"ğŸ“„ STIX æ–‡ä»¶: {stix_path}")

    try:
        # åˆå§‹åŒ–æœåŠ¡
        stix_service = STIXDataService(stix_path)
        stats = stix_service.get_statistics()
        logger.info(f"âœ“ STIX æ•°æ®æºåŠ è½½æˆåŠŸ")
        logger.info(f"  - æˆ˜æœ¯: {stats['tactics']} ä¸ª")
        logger.info(f"  - çˆ¶æŠ€æœ¯: {stats['techniques']} ä¸ª")
        logger.info(f"  - å­æŠ€æœ¯: {stats['subtechniques']} ä¸ª")

        # è¿æ¥æ•°æ®åº“
        conn = sqlite3.connect(str(DB_PATH))
        cursor = conn.cursor()

        try:
            # æ¸…ç©ºç°æœ‰æ•°æ®ï¼ˆå¦‚æœæŒ‡å®šï¼‰
            if args.clear:
                clear_existing_data(conn, cursor)

            # å¯¼å…¥æˆ˜æœ¯
            import_tactics(stix_service, conn, cursor)

            # å¯¼å…¥æŠ€æœ¯
            import_techniques(stix_service, conn, cursor)

            # éªŒè¯
            verify_import(cursor)

            print("\n" + "=" * 50)
            print("âœ… æ•°æ®å¯¼å…¥æˆåŠŸå®Œæˆ!")
            print("=" * 50)
            return True

        except Exception as e:
            logger.error(f"\nâŒ å¯¼å…¥å¤±è´¥: {e}", exc_info=True)
            conn.rollback()
            return False
        finally:
            conn.close()

    except Exception as e:
        logger.error(f"âŒ åˆå§‹åŒ–å¤±è´¥: {e}", exc_info=True)
        return False


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
