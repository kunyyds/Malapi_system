# MalAPI系统能力点清单

## 项目概述

MalAPI系统是一个专业的恶意软件API管理和分析平台，基于ATT&CK框架提供可视化展示、智能分析和安全研究功能。本能力点清单基于项目实际代码实现状态、技术文档和需求分析生成。

---

## 1.1 攻击矩阵构建模块【模块级需规，粗粒度】

具有ATT&CK映射和智能化分析能力，对代码进行映射约束形成体系化的ATT&CK矩阵，通过LLM实现对代码的详解和攻击方案构建。

### a. 说明
该模块负责构建和维护ATT&CK战术-技术映射关系矩阵，通过智能化映射机制将恶意软件API函数与ATT&CK技术进行关联，形成完整的攻击技术覆盖矩阵。支持从静态JSON文件到动态API数据源的迁移，实现数据的实时同步和更新。

### b. 输入
- **数据源**: MITRE ATT&CK Enterprise Matrix数据 (matrix-enterprise.json)
- **函数数据**: MalFocus解析结果包含manifest.json元数据
- **映射关系**: 函数manifest中的ATT&CK字段 (如: "attck": ["T1027", "T1055"])
- **配置参数**: 是否包含子技术、平台筛选、战术筛选

### c. 处理
1. **ATT&CK基础数据导入**: 解析STIX格式的ATT&CK数据，导入战术(tactics)和技术(techniques)表
2. **映射关系建立**: 从函数manifest_json提取ATT&CK ID，建立与techniques表的关联映射
3. **矩阵数据组织**: 按战术维度组织技术数据，支持父子技术关系
4. **数据验证**: 验证技术ID有效性，确保外键约束完整性
5. **统计计算**: 计算每个技术的函数数量、覆盖率等统计指标

### d. 输出
- **ATT&CK矩阵数据**: 结构化的战术-技术二维矩阵
- **技术详情**: 包含描述、检测方法、关联函数等信息
- **统计信息**: 战术数、技术数、子技术数、覆盖率统计
- **可视化数据**: 适用于ECharts热力图的数据格式

### e. 异常处理
- **无效技术ID**: 记录无效的ATT&CK ID，跳过映射建立
- **JSON解析错误**: 处理manifest_json格式错误，记录错误日志
- **数据库连接失败**: 使用SQLite本地缓存，确保基础功能可用
- **数据不一致**: 定期检查manifest_json与映射表的一致性，自动修复差异

---

## 1.2 代码测试模块【模块级需规，粗粒度】

具有代码质量评估和功能验证能力，通过LLM实现对代码的置信度评价和自动修正，确保生成的恶意软件代码符合预期功能要求。

### a. 说明
该模块提供全方位的代码质量评估和测试验证功能，包括语法正确性检查、逻辑完整性验证、功能符合度评估，以及基于AI的代码修正建议。支持自动化测试流程和代码置信度评分机制。

### b. 输入
- **待测代码**: C/C++恶意软件函数源代码
- **预期功能**: JSON格式的功能描述和预期行为
- **测试用例**: 针对特定攻击场景的测试用例
- **评估标准**: 代码质量指标和功能符合度标准

### c. 处理
1. **静态代码分析**: 检查语法错误、编译警告、潜在安全漏洞
2. **功能符合度评估**: 使用LLM分析代码与预期功能描述的匹配程度
3. **代码质量评分**: 从可读性、维护性、性能等维度进行评分
4. **测试用例生成**: 基于功能描述自动生成测试用例
5. **修正建议生成**: LLM分析问题并生成具体的代码修正方案

### d. 输出
- **代码质量报告**: 包含评分、问题列表、改进建议的详细报告
- **功能验证结果**: 功能符合度评分和具体差异分析
- **测试用例集合**: 自动生成的测试用例和预期结果
- **修正代码**: 经过LLM优化的修正版代码
- **置信度评分**: 整体代码可信度和可靠性评分

### e. 异常处理
- **编译错误**: 提供详细的编译错误信息和建议修复方案
- **LLM服务不可用**: 降级到基础静态分析功能
- **测试用例生成失败**: 使用预设的标准测试用例库
- **评估超时**: 设置合理的评估时间限制，避免长时间阻塞

---

## 2.1 数据导入处理功能【能力】

### 2.1.1 功能概述
提供从MalFocus解析结果到数据库的完整数据导入流程，支持批量处理、增量更新和数据验证。

### 2.1.2 工作流程
1. **文件扫描**: 递归扫描指定目录，识别包含manifest.json的函数目录
2. **数据解析**: 解析manifest.json元数据和函数源代码文件
3. **数据验证**: 验证ATT&CK ID有效性、检查数据完整性
4. **批量导入**: 使用事务处理批量导入数据库，确保数据一致性
5. **映射建立**: 自动建立函数与ATT&CK技术的映射关系
6. **统计报告**: 生成导入统计报告和错误日志

### 2.1.3 界面示意
- **管理界面**: `/api/v1/admin/db` 提供数据导入管理功能
- **进度显示**: 实时显示导入进度和统计信息
- **错误报告**: 详细的错误列表和处理建议
- **数据验证**: 导入前后数据一致性验证界面

---

## 2.2 智能搜索功能【能力】

### 2.2.1 功能概述
提供多维度全文搜索能力，支持函数名、代码内容、ATT&CK技术、描述等多种搜索类型，具备实时搜索建议和高级筛选功能。

### 2.2.2 工作流程
1. **搜索请求解析**: 解析用户查询意图和搜索类型
2. **多字段匹配**: 在函数名、别名、摘要、代码内容中进行全文搜索
3. **ATT&CK关联**: 搜索与ATT&CK技术相关的函数
4. **结果排序**: 按相关度、更新时间等进行智能排序
5. **分页返回**: 支持分页和每页大小控制
6. **搜索建议**: 基于历史搜索和内容提供智能建议

### 2.2.3 界面示意
- **搜索框**: 主页顶部的智能搜索框，支持自动补全
- **高级搜索**: 可展开的高级搜索选项，支持多条件筛选
- **搜索结果**: 结果列表显示匹配函数的关键信息
- **搜索历史**: 保存用户搜索历史和热门搜索词

---

## 2.3 AI分析功能【能力】

### 2.3.1 功能概述
基于大语言模型提供智能代码分析能力，包括代码解释、攻击场景分析、攻击方案生成等功能。

### 2.3.2 工作流程
1. **代码预处理**: 提取关键代码段和上下文信息
2. **LLM分析**: 调用OpenAI API进行代码语义分析
3. **攻击场景识别**: 识别代码中使用的攻击技术
4. **方案生成**: 基于分析结果生成详细的攻击方案
5. **结果优化**: 对LLM输出进行格式化和质量检查
6. **缓存管理**: 缓存分析结果，控制API调用成本

### 2.3.3 界面示意
- **代码输入**: 大文本框支持代码粘贴和文件上传
- **分析选项**: 可选择分析类型（解释、攻击场景、方案生成）
- **结果展示**: 格式化的分析结果，支持代码高亮
- **导出功能**: 支持将分析结果导出为PDF或Word文档

---

## 2.4 可视化展示功能【能力】

### 2.4.1 功能概述
提供ATT&CK矩阵的可视化展示能力，包括热力图、技术详情页面、统计图表等多种可视化形式。

### 2.4.2 工作流程
1. **矩阵数据获取**: 从后端API获取最新的ATT&CK矩阵数据
2. **热力图渲染**: 使用ECharts生成交互式热力图
3. **统计图表**: 生成技术分布、覆盖率等统计图表
4. **详情展示**: 点击技术显示详细信息和关联函数
5. **数据更新**: 支持实时数据更新和增量刷新

### 2.4.3 界面示意
- **矩阵主页**: 主要的ATT&CK矩阵热力图页面
- **技术详情**: 技术详细信息页面，包含描述、检测方法、函数列表
- **统计面板**: 显示系统整体统计信息和关键指标
- **筛选控件**: 支持按平台、战术等维度筛选数据

---

## 3. 技术架构能力点

### 3.1 后端架构能力

#### 3.1.1 API服务能力
- **FastAPI框架**: 完整的RESTful API实现，包含自动文档生成
- **异步处理**: 使用async/await提供高性能异步服务
- **中间件支持**: CORS、认证、日志等中间件完整配置
- **错误处理**: 统一的异常处理机制和错误响应格式

#### 3.1.2 数据管理能力
- **SQLAlchemy ORM**: 完整的数据模型定义和关系映射
- **数据库支持**: SQLite开发环境，PostgreSQL生产环境
- **连接优化**: 连接池、WAL模式等数据库优化配置
- **迁移管理**: 完整的数据库初始化和迁移脚本

#### 3.1.3 LLM集成能力
- **OpenAI集成**: 完整的OpenAI API调用封装
- **成本控制**: 预算控制、使用统计、缓存机制
- **多模型支持**: 支持GPT-4、GPT-3.5等不同模型
- **错误处理**: API调用失败的重试和降级机制

### 3.2 前端架构能力

#### 3.2.1 React应用能力
- **TypeScript支持**: 完整的类型定义和类型安全
- **Ant Design**: 企业级UI组件库集成
- **路由管理**: React Router完整的页面路由配置
- **状态管理**: 合理的组件状态管理和数据流

#### 3.2.2 数据服务能力
- **API集成**: 完整的后端API调用封装
- **类型安全**: TypeScript接口定义和类型检查
- **错误处理**: 前端错误处理和用户友好的错误提示
- **数据缓存**: 合理的数据缓存和更新策略

### 3.3 开发运维能力

#### 3.3.1 环境管理能力
- **Conda环境**: 完整的Python环境管理
- **自动化脚本**: 环境设置、服务启动等自动化脚本
- **Docker支持**: 容器化部署配置
- **Make命令**: 便捷的开发命令集合

#### 3.3.2 测试质量能力
- **pytest框架**: 完整的测试框架和测试用例
- **配置化测试**: 环境变量控制的测试配置
- **代码质量**: 代码风格检查和类型检查工具
- **文档完善**: 详细的技术文档和API文档

---

## 8. 数据管理详细能力

### 8.1 数据库设计能力

#### 8.1.1 核心数据模型
- **malapi_functions**: 恶意软件函数表，包含hash_id、alias、summary等字段
- **attack_tactics**: ATT&CK战术表，包含tactic_id、tactic_name_en等字段
- **attack_techniques**: ATT&CK技术表，包含technique_id、technique_name等字段
- **attck_mappings**: 函数与技术的映射关系表
- **attack_technique_tactics**: 技术与战术的关联表

#### 8.1.2 数据完整性保证
- **外键约束**: 确保映射关系的数据完整性
- **级联操作**: 合理的级联删除和更新策略
- **索引优化**: 关键字段建立索引提升查询性能
- **数据验证**: 应用层和数据库层的双重验证

### 8.2 数据处理流程能力

#### 8.2.1 数据导入流程
- **批量处理**: 支持大量函数数据的批量导入
- **事务管理**: 使用数据库事务确保导入过程的数据一致性
- **错误恢复**: 导入失败时的回滚和错误报告机制
- **增量更新**: 支持增量数据更新和重复导入检测

#### 8.2.2 数据同步机制
- **ATT&CK更新**: 支持MITRE ATT&CK框架的定期更新
- **映射维护**: 自动维护函数与ATT&CK技术的映射关系
- **数据校验**: 定期检查数据完整性和一致性
- **备份恢复**: 完整的数据备份和恢复机制

---

*本文档基于项目实际代码状态和技术文档生成，包含第1-8部分内容。实现状态评估、开发优先级和技术债务改进内容分别见以下文档：*
- *IMPLEMENTATION_STATUS.md - 实现状态评估*
- *DEVELOPMENT_ROADMAP.md - 开发优先级路线图*
- *TECHNICAL_DEBT.md - 技术债务与改进建议*

*最后更新时间：2025-01-08*